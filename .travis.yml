addons:
  apt:
    sources:
      - chef-current-xenial
    packages:
      - chef-workstation

if: sender != "github-actions[bot]"

branches:
  only:
    - master
    - /^\d+\.\d+(\.\d+)?(-\S*)?$/

services: docker

env:
  global:
    - CHEF_LICENSE=accept
    - KITCHEN_LOCAL_YAML=kitchen.dokken.yml

install:
  - sudo iptables -L DOCKER || ( echo "DOCKER iptables chain missing" ; sudo iptables -N DOCKER )
  - eval "$(chef shell-init bash)"
  - openssl aes-256-cbc -K $encrypted_8e7e50a45291_key -iv $encrypted_8e7e50a45291_iv -in codenamephp.pem.enc -out codenamephp.pem -d

script:
  - chef exec foodcritic .
  - chef exec rubocop
  - chef exec rspec
  - chef exec kitchen test

before_deploy:
  - chef exec knife cookbook metadata from file metadata.rb
deploy:
  provider: chef_supermarket
  user_id: "codenamephp"
  client_key: "codenamephp.pem"
  category: "Utilities"
  edge: true
  run:
    - chef exec berks upload -e test
  on:
    tags: true

notifications:
  slack:
    rooms:
      - secure: "lEK7KTvImY9Np/hEoOAbNwiOeM5HfZPwMNq4b4lyAPgEYU1z0rV2pcUAHSjagUOZ8JDX9xpbBrKA4obvhO461v8p7hT8DY0lGMVVJQxKzzgxmX6wdUXfDplrchHrTIPyRNrVlVeV5tX3+TwC805P2eGaJOVTlcwcG5SYSNPuAGjviZWINR3COgTI4ZeIDee1D2W9wnhh08mOcTg77CTjaV0bOuBsKzpGOGeVTpNhhlM4LaK5wjFa8y2qD5Ot49fmHFdpJaWRlM8S8ma94dkDVPXdIR8q44TScDdnuvkAHalXUhthDEYGEDnWVwU2EsfjJSAPYREJ9/86l0+dOYTbD5wlphgsnqdWt7zZZFUs+xBl2ZufF8UvMrfTJ9JVYLiG+ZybADONCjrONvMn9As1Lt19wpJdKBRCL+GZXMT3Q+viIhnDTRvJep+hMmlazWCNAPPHtIrczKD01UFeYE0faZdkQ99+15Zqz3aFRbMH8GxHMa4RFLv47xSAbojKlLPtee+DFWExTVGEPkFPcirLFOKoOeOkdU1UFqE6dkbm8+FHmsiUXrbPEnfJ3313oWVeKLP62mmaQFV2rn6LAHZGmQGO9Kj31p2jCxCiXIMZ6+igrFvPd97wa8M6C+vZ8aze4dTbZwI7xBK6fdgT2amjGV4QJmbyhNOt6xHMd1J8U3A="
    on_success: never
    on_failure: always
